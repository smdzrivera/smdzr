!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i=t();for(var n in i)("object"==typeof exports?exports:e)[n]=i[n]}}(self,(()=>(()=>{var e={710:()=>{let e,t=!1;AFRAME.registerComponent("change-room",{schema:{on:{type:"string",default:"click"},room:{type:"string",default:""},url:{type:"string",default:""},select:{type:"string",default:"#scene"},target:{type:"string",default:"#scene"}},init(){this.changeRoom=this.changeRoom.bind(this)},async changeRoom(){if(t)return;const i=this.el.sceneEl,{url:n,select:a,target:s}=this.data;try{t=!0,window.history.pushState(null,"",n);const o=await fetch(n);if(!o.ok)throw new Error("Network response was not ok");const r=await o.text(),h=(new DOMParser).parseFromString(r,"text/html").querySelector(a);if(h?document.querySelector(s).outerHTML=h.outerHTML:console.error(`Element ${s} not found in the fetched document.`),i.getAttribute("networked-scene").room===this.data.room)return void(t=!1);e||(e={...i.getAttribute("networked-scene"),connectOnLoad:!1}),e.room=this.data.room,i.removeAttribute("networked-scene"),setTimeout((()=>{i.setAttribute("networked-scene",e),i.emit("connect"),document.body.addEventListener("connected",(()=>{t=!1;const e=document.getElementById("rig");e.setAttribute("networked-aframe",{creator:NAF.clientId}),NAF.utils.takeOwnership(e)}),{once:!0})}),1e3)}catch(e){t=!1,console.error("There has been a problem with the fetch operation:",e)}},play(){this.el.addEventListener(this.data.on,this.changeRoom)},pause(){this.el.removeEventListener(this.data.on,this.changeRoom)}})},134:()=>{const e=[["SittingIdle","https://cdn.glitch.global/3e6e78f9-b796-4cf3-8451-2fcba6103a3c/SittingIdle_man.fbx?v=1711641528318",{ignoreBones:["Spine1","Spine2","Neck","Head","LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.1}],["Idle","https://cdn.glitch.global/d8f22817-cf4b-44e4-9cc1-0633ac6cda8d/BreathingIdle.fbx?v=1701432248342",{ignoreBones:["Spine1","Spine2","Neck","Head","LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.1}],["Walking","https://cdn.glitch.global/d8f22817-cf4b-44e4-9cc1-0633ac6cda8d/Walking.fbx?v=1701432532423",{ignoreBones:["LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.1,removeHipsForwardAnimation:!0}],["Dying","https://cdn.glitch.global/3e6e78f9-b796-4cf3-8451-2fcba6103a3c/Dying.fbx?v=1703867995062",{ignoreBones:["LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:0}]],t=[["SittingIdle","https://cdn.glitch.global/3e6e78f9-b796-4cf3-8451-2fcba6103a3c/SittingIdle_woman.fbx?v=1711641103935",{ignoreBones:["Spine1","Spine2","Neck","Head","LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.1}],["Idle","https://cdn.glitch.global/d8f22817-cf4b-44e4-9cc1-0633ac6cda8d/BreathingIdle.fbx?v=1701432248342",{ignoreBones:["Spine1","Spine2","Neck","Head","LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.168}],["Walking","https://cdn.glitch.global/d8f22817-cf4b-44e4-9cc1-0633ac6cda8d/Walking.fbx?v=1701432532423",{ignoreBones:["LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:-.168,removeHipsForwardAnimation:!0}],["Dying","https://cdn.glitch.global/3e6e78f9-b796-4cf3-8451-2fcba6103a3c/Dying.fbx?v=1703867995062",{ignoreBones:["LeftEye","LeftEye_end","LeftEye_end_end","RightEye","RightEye_end","RightEye_end_end"],positionMultiplier:.01,positionOffset:0}]],i={};NAF.schemas.getComponentsOriginal=NAF.schemas.getComponents,NAF.schemas.getComponents=e=>(NAF.schemas.hasTemplate("#avatar-template")||NAF.schemas.add({template:"#avatar-template",components:["avatar-bones","player-info",{component:"position",requiresNetworkUpdate:NAF.utils.vectorRequiresUpdate(.001)},{component:"rotation",requiresNetworkUpdate:NAF.utils.vectorRequiresUpdate(.5)},{selector:".model",component:"rotation",requiresNetworkUpdate:NAF.utils.vectorRequiresUpdate(.5)}]}),NAF.schemas.getComponentsOriginal(e));const n=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI),a=e=>Math.round(100*e)/100;function s(e,t){for(let i=0,n=function(e){return Array.isArray(e)?e:e.bones}(t);i<n.length;i++)if(e===n[i].name)return n[i]}function o(e,t,i={}){const n=i.names??{},a=i.offsets??{},o=i.positionMultiplier??1,r=i.inverseBones??!1,h=i.ignoreBones??[],l=i.removeHipsForwardAnimation??!1,d=i.positionOffset??0,c=[],p=new THREE.Quaternion;return t.tracks.forEach((u=>{const m=u.name.split("."),f=m[0],g=n[f]||f,y=m[1];if(s(g,e.skeleton)||"Armature"===g)if(h.indexOf(g)>-1)console.log(t.name,"ignore track",g);else if(u instanceof THREE.VectorKeyframeTrack&&u.name.endsWith("position")&&i.hip===g){const e=new THREE.VectorKeyframeTrack(`${g}.${y}`,u.times,u.values.map(((e,t)=>(e*=o,l&&t%3==1&&(e=0),0!==d&&t%3==2&&(e+=d),e))));c.push(e)}else if(u instanceof THREE.QuaternionKeyframeTrack){const e=u.times,t=u.values.map(((e,t)=>r&&t%2==0?-e:e)),i=a[g];if(i){const e=u.values.length/4;for(let n=0;n<e;++n)p.fromArray(t,4*n),p.multiply(i),p.toArray(t,4*n)}const n=new THREE.QuaternionKeyframeTrack(`${g}.${y}`,e,t);c.push(n)}})),new THREE.AnimationClip(t.name,t.duration,c)}AFRAME.registerComponent("avatar-bones",{schema:{Head:{type:"vec4"}},init:function(){"rig"!==this.el.id&&(this.headBuffer=new NAF.InterpolationBuffer(0,.1)),this.localEuler=new THREE.Euler,this.localQuaternion=new THREE.Quaternion,this.localQuaternion2=new THREE.Quaternion,this.localQuaternion3=new THREE.Quaternion,this.tmpQuaternion=new THREE.Quaternion,this.transitionQuaternionStart=new THREE.Quaternion,this.transitionQuaternionEnd=new THREE.Quaternion,this.prevTime=0,this.transitionProgress=1},events:{"model-loaded":function(){queueMicrotask((()=>{if(this.mesh=this.el.components["player-info"].mesh,this.mesh){const e=this.mesh.skeleton.bones;this.hips=s("Hips",e),this.spine=s("Spine",e),this.spine1=s("Spine1",e),this.spine2=s("Spine2",e),this.neck=s("Neck",e),this.head=s("Head",e),this.spine1quaternion=(new THREE.Quaternion).copy(this.spine1.quaternion),this.spine2quaternion=(new THREE.Quaternion).copy(this.spine2.quaternion),this.neckquaternion=(new THREE.Quaternion).copy(this.neck.quaternion)}}))}},update:function(e){"rig"===this.el.id||this.headBuffer.setQuaternion(this.data.Head)},tick:function(e,t){if("rig"===this.el.id){if(this.head){if(!this.cameraEl&&(this.cameraEl=this.el.querySelector(".camera"),!this.cameraEl))return void console.log("No .camera found on rig children");const i=this.cameraEl.object3D,s=this.el.components["player-info"].avatarEl.object3D.quaternion,o=this.localQuaternion.copy(i.quaternion).multiply(n),r=this.localEuler.setFromQuaternion(o,"YXZ");r.x=0,r.z=0;const h=this.localQuaternion2.setFromEuler(r);if((s.angleTo(h)>.5||e-this.prevTime>2e3)&&(this.transitionProgress=0,this.transitionQuaternionStart.copy(s),this.transitionQuaternionEnd.copy(h),this.prevTime=e),this.transitionProgress<1&&(this.transitionProgress+=.006*t,s.slerpQuaternions(this.transitionQuaternionStart,this.transitionQuaternionEnd,this.transitionProgress)),"Idle"!==this.el.components["player-info"].data.state)return;this.spine1.quaternion.copy(this.spine1quaternion),this.spine2.quaternion.copy(this.spine2quaternion),this.neck.quaternion.copy(this.neckquaternion),this.head.quaternion.copy(o).premultiply(this.localQuaternion3.copy(s).invert());const l=this.head.rotation.z;this.head.rotation.z=-this.head.rotation.x,this.head.rotation.x=l,this.head.rotation.y-=.3,this.head.rotation.z=Math.max(-1,Math.min(.7,this.head.rotation.z)),this.head.rotation.x=Math.max(-1,Math.min(1,this.head.rotation.x)),this.data.Head.x=a(this.head.quaternion.x),this.data.Head.y=a(this.head.quaternion.y),this.data.Head.z=a(this.head.quaternion.z),this.data.Head.w=a(this.head.quaternion.w)}}else{if("Idle"!==this.el.components["player-info"].data.state)return;this.spine1&&this.spine1.quaternion.copy(this.spine1quaternion),this.spine2&&this.spine2.quaternion.copy(this.spine2quaternion),this.neck&&this.neck.quaternion.copy(this.neckquaternion),this.headBuffer.update(t),this.head&&this.head.quaternion.copy(this.headBuffer.getQuaternion())}}}),AFRAME.registerComponent("player-info",{dependencies:["avatar-bones"],schema:{name:{type:"string",default:"anonymous"},color:{type:"color",default:"#ffffff"},avatarSrc:{type:"string",default:""},state:{type:"string",default:"Idle"},muted:{type:"boolean",default:!1},avatarPose:{type:"string",default:"stand",oneOf:["stand","sit"]},seatRotation:{type:"number",default:0}},init:function(){this.nametag=this.el.querySelector(".nametag"),this.setAnimation=this.setAnimation.bind(this),this.setAnimationFromState=this.setAnimationFromState.bind(this),this.getAnimationMixer=this.getAnimationMixer.bind(this),this.removeAnimationMixer=this.removeAnimationMixer.bind(this),this.positionChanged=this.positionChanged.bind(this),this.isAtCloseDistance=this.isAtCloseDistance.bind(this),this.maxDistanceSquared=.25,this.rig=document.querySelector("#rig"),this.fbxLoader=new THREE.FBXLoader,this.glbLoader=new THREE.GLTFLoader,this.updatedEventDetail={el:void 0,data:void 0,oldData:void 0}},update:function(e){this.updatedEventDetail.data=this.data,this.updatedEventDetail.oldData=e,this.updatedEventDetail.el=this.el,this.el.sceneEl.emit("player-info-updated",this.updatedEventDetail),this.updatedEventDetail.data=void 0,this.updatedEventDetail.oldData=void 0,this.updatedEventDetail.el=void 0,this.nametag&&this.nametag.setAttribute("value",this.data.name),this.avatarEl=this.el.querySelector(".model"),this.avatarEl||(this.avatarEl=document.createElement("a-entity"),this.el.appendChild(this.avatarEl),this.avatarEl.setAttribute("class","model")),this.avatarEl.setAttribute("shadow",""),this.el.object3D.rotation.order="YXZ",this.avatarEl.object3D.rotation.order="YXZ",e&&this.data.avatarSrc&&e.avatarSrc&&this.data.avatarSrc!==e.avatarSrc&&(this.mesh=void 0,this.removeAnimationMixer()),this.data.avatarSrc&&this.avatarEl.setAttribute("gltf-model",this.data.avatarSrc),this.mesh&&this.mixer&&e&&this.data&&(e.state!==this.data.state||e.avatarPose!==this.data.avatarPose)&&this.setAnimationFromState()},tick:function(e){if("rig"!==this.el.id&&(this.el.object3D.visible=!this.isAtCloseDistance(this.rig.object3D,this.el.object3D)),this.mesh){const t=this.mesh.morphTargetDictionary;e%6e3<500&&(this.startBlinking=!0);const i=(Math.sin(e/100)+1)/2;i<.3&&(this.startBlinking=!1,this.mesh.morphTargetInfluences[t["h_expressions.ReyeClose_h"]]=0,this.mesh.morphTargetInfluences[t["h_expressions.LeyeClose_h"]]=0),this.startBlinking&&(this.mesh.morphTargetInfluences[t["h_expressions.ReyeClose_h"]]=i,this.mesh.morphTargetInfluences[t["h_expressions.LeyeClose_h"]]=i)}},setAnimation:function(e){this.avatarEl.setAttribute("animation-mixer",e)},setAnimationFromState(){let e=this.data.state;"Idle"===this.data.state&&(e="sit"===this.data.avatarPose?"SittingIdle":"Idle"),this.setAnimation(`clip:${e};loop:repeat`)},getAnimationMixer:function(){return this.avatarEl.getAttribute("animation-mixer")},removeAnimationMixer:function(){this.avatarEl.removeAttribute("animation-mixer"),this.mixer=null},positionChanged(){this.el.sceneEl.systems.waypoint?.occupyWaypoint&&this.el.sceneEl.systems.waypoint.unoccupyWaypoint(),this.mixer&&(clearTimeout(this.revertToIdleTimeout),this.revertToIdleTimeout=setTimeout((()=>{this.el.setAttribute("player-info","state","Idle")}),100),this.el.setAttribute("player-info","state","Walking"))},isAtCloseDistance:function(e,t){const i=e.position,n=t.position,a=i.x-n.x,s=i.z-n.z;return a*a+s*s<this.maxDistanceSquared},events:{teleported:function(e){this.positionChanged()},moved:function(e){this.positionChanged()},"navigation-start":function(e){this.el.sceneEl.systems.waypoint?.occupyWaypoint&&this.el.sceneEl.systems.waypoint.unoccupyWaypoint(),this.el.hasAttribute("simple-navmesh-constraint")&&this.el.setAttribute("simple-navmesh-constraint","enabled",!1),this.el.setAttribute("player-info","state","Walking")},"navigation-end":function(e){this.el.hasAttribute("simple-navmesh-constraint")&&this.el.setAttribute("simple-navmesh-constraint","enabled",!0),this.el.setAttribute("player-info","state","Idle")},"model-loaded":function(n){"rig"===this.el.id&&this.avatarEl.object3D.traverse((e=>{e.layers&&(e.layers.disableAll(),e.layers.enable(3))})),this.avatarEl.object3D.traverse((e=>{e.isMesh&&(e.frustumCulled=!1)}));const a=n.detail.model;if(a.name="Armature",this.mesh=a.getObjectByName("H_DDS_HighRes"),!this.mesh)return;const s=()=>{a.animations=Array.from(i[h].animations),this.setAnimationFromState(),this.mixer=this.getAnimationMixer()},r=this.data.avatarSrc.indexOf("_F_")>-1,h=`valid-${r}`;if(i[h]=i[h]||{},i[h].animations)s();else{if(!i[h].promise){const n=new Promise(((n,a)=>{(async()=>{const a=r?t:e,s=[];for(let[e,t,i]of a){const n=t.indexOf(".glb")>-1?this.glbLoader:this.fbxLoader;i=i??{},!1===window.USE_GLITCH&&(t=new URL(t).pathname.split("/").pop());const a=(await n.loadAsync(t)).animations[0];let r=a;a.name=e,r=o(this.mesh,a,{hip:"Hips",names:{Reference:"Armature"},offsets:i.quatOffsets??{},positionMultiplier:i.positionMultiplier??1,positionOffset:i.positionOffset??0,ignoreBones:i.ignoreBones??[],removeHipsForwardAnimation:i.removeHipsForwardAnimation??!1}),console.log("retargeted",a.name,"renamed to",e),s.push(r),console.log("animation after conversion",r)}i[h].animations=s,n()})()}));i[h].promise=n}i[h].promise.then(s).catch((()=>{console.error("Error loading the animations")}))}}}})}},t={};function i(n){var a=t[n];if(void 0!==a)return a.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};return(()=>{"use strict";i.r(n),i(134),i(710),AFRAME.registerComponent("spawn-in-circle",{schema:{radius:{type:"number",default:1}},init:function(){const e=this.el,t=e.getAttribute("position"),i=this.getRandomAngleInRadians(),n=this.randomPointOnCircle(this.data.radius,i),a={x:n.x+t.x,y:t.y,z:n.y+t.z};e.setAttribute("position",a)},getRandomAngleInRadians:function(){return 2*Math.PI*(Math.floor(8*Math.random())/8)},randomPointOnCircle:function(e,t){return{x:Math.cos(t)*e,y:Math.sin(t)*e}}})})(),n})()));
//# sourceMappingURL=components.js.map